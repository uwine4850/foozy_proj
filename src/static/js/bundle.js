(()=>{"use strict";var e={391:(e,t,n)=>{n.r(t)},872:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ajaxGET=t.Ajax=void 0;var n=function(){function e(e,t){this.path=e,this.formId=t}return e.prototype.onSuccess=function(e){this.onSuccessFn=e},e.prototype.onError=function(e){this.onErrorFn=e},e.prototype.listen=function(){var e=this;$(document).ready((function(){$("#"+e.formId).submit((function(t){t.preventDefault();var n=$(e).serialize();$.ajax({type:"POST",url:e.path,data:n,success:function(t){e.onSuccessFn(t)},error:function(t,n,s){e.onErrorFn(s)}})}))}))},e}();t.Ajax=n,t.ajaxGET=function(e,t,n,s){$.ajax({url:e,method:"GET",data:t,json:!0,success:function(e){n(e)},error:function(e,t,n){s(n)}})}},862:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.RunWs=t.MsgType=void 0;var s,a=n(842),o=n(417);!function(e){e[e.Connect=0]="Connect",e[e.TextMsg=1]="TextMsg",e[e.ReadMsg=2]="ReadMsg",e[e.Error=3]="Error"}(s||(t.MsgType=s={}));var r={Socket:null,Uid:null,ChatId:null};t.RunWs=function(){var e=document.getElementById("chat-textarea"),t=new WebSocket("ws://localhost:8000/chat-ws");return r.Socket=t,t.addEventListener("open",(function(e){console.log("Connect.")})),t.addEventListener("message",(function(e){if(""!=e.data){var t=JSON.parse(e.data);switch(t.Type){case s.Error:console.log(t.Msg.Error);break;case s.TextMsg:var n=document.getElementById("chat-content"),c="",i="";t.Uid==r.Uid?(c="chat-content-msg-my-msg",i='<div class="chat-msg-not-read-my"></div>'):c="chat-msg-not-read chat-msg-not-read-obs",n.innerHTML+=' \n                    <div data-msgid="'.concat(t.Msg.Id,'" class="chat-content-msg ').concat(c,'">\n                        ').concat(i,'\n                        <div class="chat-content-msg-text">\n                            ').concat(t.Msg.Text,'\n                        </div>\n                        <div class="chat-content-msg-date">').concat(t.Msg.Date,"</div>\n                    </div>"),(0,a.observeMessages)(r),(0,o.runLazyLoadMsg)(r),(0,o.runLazyLoadNotReadMsg)(r);break;case s.Connect:r.Uid=t.Uid,r.ChatId=t.ChatId;break;case s.ReadMsg:var d=document.querySelector('[data-msgid="'.concat(t.Msg.Id,'"]'));d.classList.contains("chat-content-msg-my-msg")&&d.querySelectorAll(".chat-msg-not-read-my").length>0&&d.querySelectorAll(".chat-msg-not-read-my")[0].remove(),d.classList.contains("chat-msg-not-read")&&d.classList.remove("chat-msg-not-read")}}})),t.addEventListener("close",(function(e){console.log("Close.")})),t.addEventListener("error",(function(e){console.error("Error:",e)})),document.getElementById("send").onclick=function(){var n={Type:s.TextMsg,Uid:r.Uid,ChatId:r.ChatId,Msg:{Text:e.value}};t.send(JSON.stringify(n)),e.value=""},r}},896:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.LazyLoad=void 0;var s=n(872),a=function(){function e(e,t,n){this.valuesData={},this.obsElementId=e,this.dataFields=t,this.url=n}return e.prototype.setOptions=function(e){this.options=e},e.prototype.getValues=function(e){for(var t=0,n=this.dataFields;t<n.length;t++){var s=n[t],a=e.getAttribute("data-"+s);null!=a&&(this.valuesData[s]=a)}return this.valuesData},e.prototype.setValue=function(e,t){this.valuesData[e]=t},e.prototype.run=function(e,t){for(var n=this,a=document.getElementsByClassName(this.obsElementId),o=new IntersectionObserver((function(a,o){a.forEach((function(a){a.isIntersecting&&(o.unobserve(a.target),(0,s.ajaxGET)(n.url,n.getValues(a.target),(function(t){e(t)}),(function(e){t(e)})),a.target.classList.remove(n.obsElementId),setTimeout((function(){for(var e=document.getElementsByClassName(n.obsElementId),t=0;t<e.length;t++)o.observe(e.item(t))}),1e3))}))}),this.options),r=0;r<a.length;r++)o.observe(a.item(r))},e}();t.LazyLoad=a},417:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.runLazyLoadNotReadMsg=t.runLazyLoadMsg=void 0;var s=n(896),a=n(842);t.runLazyLoadMsg=function(e){if(document.getElementById("last-msg")){var t=new s.LazyLoad("last-msg",["first","msgtype","uid","chatid","msgid"],"/load-messages");t.setOptions({root:null,threshold:.5}),t.setValue("handler","read"),t.run((function(t){var n=document.getElementById("chat-content");if(t.error)console.log(t.error);else{var s=n.scrollTop,o=n.scrollHeight,r=t.type;if(1==t.first&&(r="read"),t.messages&&"read"==r){for(var c=t.messages,i=0;i<c.length;i++){var d='data-first="0" data-msgtype="'.concat(r,'" data-msgid="').concat(c[i].Id,'"'),l="",u="",g="";if(i==c.length-1&&(d+='data-chatid="'.concat(t.chatId,'" id="last-msg"'),g+="last-msg"),t.uid==c[i].UserId&&(l="chat-content-msg-my-msg"),t.uid==c[i].UserId||"0"!=c[i].IsRead){"0"==c[i].IsRead&&(u='<div class="chat-msg-not-read-my"></div>');var m="\n                        <div ".concat(d,' class="chat-content-msg ').concat(l," ").concat(""," ").concat(g,'">\n                            ').concat(u,'\n                            <div class="chat-content-msg-text">\n                                ').concat(c[i].Text,'\n                            </div>\n                            <div class="chat-content-msg-date">').concat(c[i].Date,"</div>\n                        </div>");document.getElementById("chat-content").insertAdjacentHTML("afterbegin",m)}}(0,a.observeMessages)(e)}else(0,a.observeMessages)(e);var v=n.scrollHeight;n.scrollTop=s+(v-o)}}),(function(e){console.log(e)}))}},t.runLazyLoadNotReadMsg=function(e){var t=new s.LazyLoad("chat-msg-not-read-obs-down",["first","msgtype","uid","chatid","msgid"],"/load-messages");t.setOptions({root:null,threshold:.5}),t.setValue("handler","notread"),t.run((function(t){var n=document.getElementById("chat-content");if(t.error)console.log(t.error);else{var s=n.scrollTop,o=(n.scrollHeight,t.type);if(1==t.first&&(o="notread"),t.messages&&"notread"==o){for(var r=t.messages,c=0;c<r.length;c++){var i='data-first="0" data-msgtype="'.concat(o,'" data-msgid="').concat(r[c].Id,'"'),d="",l="",u="",g="";c==r.length-1&&(i='data-chatid="'.concat(t.chatId,'" data-msgid="').concat(r[c].Id,'" id="last-msg"'),g+="chat-msg-not-read-obs-down"),t.uid==r[c].UserId&&(d="chat-content-msg-my-msg"),t.uid!=r[c].UserId&&"0"==r[c].IsRead&&(u="chat-msg-not-read chat-msg-not-read-obs"),"0"==r[c].IsRead&&(l='<div class="chat-msg-not-read-my"></div>');var m="\n                        <div ".concat(i,' class="chat-content-msg ').concat(d," ").concat(u," ").concat(g,'">\n                            ').concat(l,'\n                            <div class="chat-content-msg-text">\n                                ').concat(r[c].Text,'\n                            </div>\n                            <div class="chat-content-msg-date">').concat(r[c].Date,"</div>\n                        </div>");document.getElementById("chat-content").insertAdjacentHTML("beforeend",m)}(0,a.observeMessages)(e)}else(0,a.observeMessages)(e);n.scrollTop=s}}),(function(e){console.log(e)}))}},842:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.observeMessages=void 0;var s=n(653),a=n(862);t.observeMessages=function(e){new s.Observer("chat-msg-not-read-obs",{root:null,threshold:.7}).run((function(t){var n=t.target.getAttribute("data-msgid");if(null!=n){var s={Type:a.MsgType.ReadMsg,Uid:e.Uid,ChatId:e.ChatId,Msg:{Id:n}};setTimeout((function(){e.Socket.send(JSON.stringify(s))}),100)}}))}},653:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Observer=void 0;var n=[],s=function(){function e(e,t){this.className=e,this.options=t}return e.prototype.run=function(e){for(var t=this,s=document.getElementsByClassName(this.className),a=new IntersectionObserver((function(s,a){s.forEach((function(s){s.isIntersecting&&!n.includes(s.target)&&(e(s),s.target.classList.remove(t.className),a.unobserve(s.target),n.push(s.target))}))}),this.options),o=0;o<s.length;o++)a.observe(s.item(o))},e}();t.Observer=s},779:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.runIfExist=void 0,t.runIfExist=function(e,t){e&&t(e)}}},t={};function n(s){var a=t[s];if(void 0!==a)return a.exports;var o=t[s]={exports:{}};return e[s](o,o.exports,n),o.exports}n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{n(391);var e=n(779),t=n(872),s=n(862),a=n(417);(0,e.runIfExist)(document.getElementById("header-user"),(function(e){e.onclick=function(){document.getElementById("hu-menu").classList.toggle("hu-menu-hidden")}})),(0,e.runIfExist)(document.getElementById("pc-menu-filter-value"),(function(e){e.onclick=function(){document.getElementById("filter-items").classList.toggle("filter-items-hidden")}})),(0,e.runIfExist)(document.getElementById("pp-del-avatar-label"),(function(e){e.onclick=function(){document.getElementById("pp-del-avatar").classList.toggle("page-panel-checkbox-true")}}));var o=new t.Ajax("/subscribe-post","subscribe-post");if(o.onSuccess((function(e){var t=document.getElementById("profile-button-subscribe"),n=document.getElementById("subscribers-value"),s=parseInt(n.innerHTML);t.classList.toggle("profile-button-unsubscribe"),t.classList.contains("profile-button-unsubscribe")?(s++,t.innerHTML='<a><img src="/static/img/subscribe.svg">Unsubscribe</a>'):(s>0&&s--,t.innerHTML='<a><img src="/static/img/subscribe.svg">Subscribe</a>'),n.innerHTML=String(s)})),o.listen(),/^\/chat\/\d+$/.test(window.location.pathname)){var r=(0,s.RunWs)();(0,a.runLazyLoadMsg)(r),(0,a.runLazyLoadNotReadMsg)(r)}})()})();