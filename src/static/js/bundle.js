(()=>{"use strict";var e={391:(e,t,s)=>{s.r(t)},872:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ajaxGET=t.Ajax=void 0;var s=function(){function e(e,t){this.path=e,this.formId=t}return e.prototype.onSuccess=function(e){this.onSuccessFn=e},e.prototype.onError=function(e){this.onErrorFn=e},e.prototype.listen=function(){var e=this;$(document).ready((function(){$("#"+e.formId).submit((function(t){t.preventDefault();var s=$(e).serialize();$.ajax({type:"POST",url:e.path,data:s,success:function(t){e.onSuccessFn(t)},error:function(t,s,n){e.onErrorFn(n)}})}))}))},e}();t.Ajax=s,t.ajaxGET=function(e,t,s,n){$.ajax({url:e,method:"GET",data:t,json:!0,success:function(e){s(e)},error:function(e,t,s){n(s)}})}},862:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.RunWs=t.MsgType=void 0;var n,a=s(842),o=s(417);!function(e){e[e.Connect=0]="Connect",e[e.TextMsg=1]="TextMsg",e[e.ReadMsg=2]="ReadMsg",e[e.Error=3]="Error"}(n||(t.MsgType=n={}));var r={Socket:null,Uid:null,ChatId:null};t.RunWs=function(){var e=document.getElementById("chat-textarea"),t=new WebSocket("ws://localhost:8000/chat-ws");return r.Socket=t,t.addEventListener("open",(function(e){console.log("Connect.")})),t.addEventListener("message",(function(e){if(""!=e.data){var t=JSON.parse(e.data);switch(t.Type){case n.Error:console.log(t.Msg.Error);break;case n.TextMsg:var s=document.getElementById("chat-content"),c="",i="";t.Uid==r.Uid?(c="chat-content-msg-my-msg",i='<div class="chat-msg-not-read-my"></div>'):c="chat-msg-not-read chat-msg-not-read-obs",s.innerHTML+=' \n                    <div data-msgid="'.concat(t.Msg.Id,'" class="chat-content-msg ').concat(c,'">\n                        ').concat(i,'\n                        <div class="chat-content-msg-text">\n                            ').concat(t.Msg.Text,'\n                        </div>\n                        <div class="chat-content-msg-date">').concat(t.Msg.Date,"</div>\n                    </div>"),(0,a.observeMessages)(r),(0,o.runLazyLoadMsg)(r),(0,o.runLazyLoadNotReadMsg)(r);break;case n.Connect:r.Uid=t.Uid,r.ChatId=t.ChatId;break;case n.ReadMsg:var d=document.querySelector('[data-msgid="'.concat(t.Msg.Id,'"]'));d.classList.contains("chat-content-msg-my-msg")&&d.querySelectorAll(".chat-msg-not-read-my").length>0&&d.querySelectorAll(".chat-msg-not-read-my")[0].remove(),d.classList.contains("chat-msg-not-read")&&d.classList.remove("chat-msg-not-read")}}})),t.addEventListener("close",(function(e){console.log("Close.")})),t.addEventListener("error",(function(e){console.error("Error:",e)})),document.getElementById("send").onclick=function(){var s={Type:n.TextMsg,Uid:r.Uid,ChatId:r.ChatId,Msg:{Text:e.value}};t.send(JSON.stringify(s)),e.value=""},r}},896:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.LazyLoad=void 0;var n=s(872),a=function(){function e(e,t,s){this.valuesData={},this.obsElementId=e,this.dataFields=t,this.url=s}return e.prototype.setOptions=function(e){this.options=e},e.prototype.getValues=function(e){for(var t=0,s=this.dataFields;t<s.length;t++){var n=s[t],a=e.getAttribute("data-"+n);null!=a&&(this.valuesData[n]=a)}return this.valuesData},e.prototype.setValue=function(e,t){this.valuesData[e]=t},e.prototype.run=function(e,t){for(var s=this,a=document.getElementsByClassName(this.obsElementId),o=new IntersectionObserver((function(a,o){a.forEach((function(a){a.isIntersecting&&(o.unobserve(a.target),(0,n.ajaxGET)(s.url,s.getValues(a.target),(function(t){e(t)}),(function(e){t(e)})),a.target.classList.remove(s.obsElementId),setTimeout((function(){for(var e=document.getElementsByClassName(s.obsElementId),t=0;t<e.length;t++)o.observe(e.item(t))}),1e3))}))}),this.options),r=0;r<a.length;r++)o.observe(a.item(r))},e}();t.LazyLoad=a},417:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.runLazyLoadNotReadMsg=t.runLazyLoadMsg=void 0;var n=s(896),a=s(842);function o(e,t){return"\n        <div ".concat(t.lastMsgData,' class="chat-content-msg ').concat(t.classes,'">\n            ').concat(t.isReadMy,'\n            <div class="chat-content-msg-text">\n                ').concat(e.Text,'\n            </div>\n            <div class="chat-content-msg-date">').concat(e.Date,"</div>\n        </div>")}t.runLazyLoadMsg=function(e){var t=new n.LazyLoad("last-msg",["first","msgtype","uid","chatid","msgid"],"/load-messages");t.setOptions({root:null,threshold:.5}),t.setValue("handler","read"),t.run((function(t){var s=document.getElementById("chat-content");if(t.error)console.log(t.error);else{var n=s.scrollTop,r=s.scrollHeight,c=t.type;if(1==t.first&&(c="read"),t.messages&&"read"==c){for(var i=t.messages,d=0;d<i.length;d++){var l={lastMsgData:'data-first="0" data-msgtype="'.concat(c,'" data-msgid="').concat(i[d].Id,'"'),isReadMy:"",classes:""};d==i.length-1&&(l.lastMsgData+='data-chatid="'.concat(t.chatId,'"'),l.classes+="last-msg"),t.uid==i[d].UserId&&(l.classes+=" chat-content-msg-my-msg"),t.uid!=i[d].UserId&&"0"==i[d].IsRead||("0"==i[d].IsRead&&(l.isReadMy='<div class="chat-msg-not-read-my"></div>'),document.getElementById("chat-content").insertAdjacentHTML("afterbegin",o(i[d],l)))}(0,a.observeMessages)(e)}else(0,a.observeMessages)(e);var u=s.scrollHeight;s.scrollTop=n+(u-r)}}),(function(e){console.log(e)}))},t.runLazyLoadNotReadMsg=function(e){var t=new n.LazyLoad("chat-msg-not-read-obs-down",["first","msgtype","uid","chatid","msgid"],"/load-messages");t.setOptions({root:null,threshold:.5}),t.setValue("handler","notread"),t.run((function(t){var s=document.getElementById("chat-content");if(t.error)console.log(t.error);else{var n=s.scrollTop,r=t.type;if(1==t.first&&(r="notread"),t.messages&&"notread"==r){for(var c=t.messages,i=0;i<c.length;i++){var d={lastMsgData:'data-first="0" data-msgtype="'.concat(r,'" data-msgid="').concat(c[i].Id,'"'),isReadMy:"",classes:""};i==c.length-1&&(d.lastMsgData='data-chatid="'.concat(t.chatId,'"'),d.classes+="chat-msg-not-read-obs-down"),t.uid==c[i].UserId&&(d.classes+=" chat-content-msg-my-msg"),t.uid!=c[i].UserId&&"0"==c[i].IsRead&&(d.classes+=" chat-msg-not-read chat-msg-not-read-obs"),"0"==c[i].IsRead&&(d.isReadMy='<div class="chat-msg-not-read-my"></div>'),document.getElementById("chat-content").insertAdjacentHTML("beforeend",o(c[0],d))}(0,a.observeMessages)(e)}else(0,a.observeMessages)(e);s.scrollTop=n}}),(function(e){console.log(e)}))}},842:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.observeMessages=void 0;var n=s(653),a=s(862);t.observeMessages=function(e){new n.Observer("chat-msg-not-read-obs",{root:null,threshold:.7}).run((function(t){var s=t.target.getAttribute("data-msgid");if(null!=s){var n={Type:a.MsgType.ReadMsg,Uid:e.Uid,ChatId:e.ChatId,Msg:{Id:s}};setTimeout((function(){e.Socket.send(JSON.stringify(n))}),100)}}))}},653:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Observer=void 0;var s=[],n=function(){function e(e,t){this.className=e,this.options=t}return e.prototype.run=function(e){for(var t=this,n=document.getElementsByClassName(this.className),a=new IntersectionObserver((function(n,a){n.forEach((function(n){n.isIntersecting&&!s.includes(n.target)&&(e(n),n.target.classList.remove(t.className),a.unobserve(n.target),s.push(n.target))}))}),this.options),o=0;o<n.length;o++)a.observe(n.item(o))},e}();t.Observer=n},779:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.runIfExist=void 0,t.runIfExist=function(e,t){e&&t(e)}}},t={};function s(n){var a=t[n];if(void 0!==a)return a.exports;var o=t[n]={exports:{}};return e[n](o,o.exports,s),o.exports}s.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{s(391);var e=s(779),t=s(872),n=s(862),a=s(417);(0,e.runIfExist)(document.getElementById("header-user"),(function(e){e.onclick=function(){document.getElementById("hu-menu").classList.toggle("hu-menu-hidden")}})),(0,e.runIfExist)(document.getElementById("pc-menu-filter-value"),(function(e){e.onclick=function(){document.getElementById("filter-items").classList.toggle("filter-items-hidden")}})),(0,e.runIfExist)(document.getElementById("pp-del-avatar-label"),(function(e){e.onclick=function(){document.getElementById("pp-del-avatar").classList.toggle("page-panel-checkbox-true")}}));var o=new t.Ajax("/subscribe-post","subscribe-post");if(o.onSuccess((function(e){var t=document.getElementById("profile-button-subscribe"),s=document.getElementById("subscribers-value"),n=parseInt(s.innerHTML);t.classList.toggle("profile-button-unsubscribe"),t.classList.contains("profile-button-unsubscribe")?(n++,t.innerHTML='<a><img src="/static/img/subscribe.svg">Unsubscribe</a>'):(n>0&&n--,t.innerHTML='<a><img src="/static/img/subscribe.svg">Subscribe</a>'),s.innerHTML=String(n)})),o.listen(),/^\/chat\/\d+$/.test(window.location.pathname)){var r=(0,n.RunWs)();(0,a.runLazyLoadMsg)(r),(0,a.runLazyLoadNotReadMsg)(r)}})()})();