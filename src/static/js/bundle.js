(()=>{"use strict";var e={391:(e,t,n)=>{n.r(t)},872:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ajaxGET=t.Ajax=void 0;var n=function(){function e(e,t){this.path=e,this.formId=t}return e.prototype.onSuccess=function(e){this.onSuccessFn=e},e.prototype.onError=function(e){this.onErrorFn=e},e.prototype.listen=function(){var e=this;$(document).ready((function(){$("#"+e.formId).submit((function(t){t.preventDefault();var n=$(e).serialize();$.ajax({type:"POST",url:e.path,data:n,success:function(t){e.onSuccessFn(t)},error:function(t,n,s){e.onErrorFn(s)}})}))}))},e}();t.Ajax=n,t.ajaxGET=function(e,t,n,s){$.ajax({url:e,method:"GET",data:t,json:!0,success:function(e){n(e)},error:function(e,t,n){s(n)}})}},862:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.RunWs=t.MsgType=void 0;var s,o=n(842),a=n(417);!function(e){e[e.Connect=0]="Connect",e[e.TextMsg=1]="TextMsg",e[e.ReadMsg=2]="ReadMsg",e[e.Error=3]="Error"}(s||(t.MsgType=s={}));var r={Socket:null,Uid:null,ChatId:null};t.RunWs=function(){var e=document.getElementById("chat-textarea"),t=new WebSocket("ws://localhost:8000/chat-ws");return r.Socket=t,t.addEventListener("open",(function(e){console.log("Connect.")})),t.addEventListener("message",(function(e){if(""!=e.data){var t=JSON.parse(e.data);switch(t.Type){case s.Error:console.log(t.Msg.Error);break;case s.TextMsg:var n=document.getElementById("chat-content"),c="",i="";t.Uid==r.Uid?(c="chat-content-msg-my-msg",i='<div class="chat-msg-not-read-my"></div>'):c="chat-msg-not-read chat-msg-not-read-obs",n.innerHTML+=' \n                    <div data-msgid="'.concat(t.Msg.Id,'" class="chat-content-msg ').concat(c,'">\n                        ').concat(i,'\n                        <div class="chat-content-msg-text">\n                            ').concat(t.Msg.Text,'\n                        </div>\n                        <div class="chat-content-msg-date">').concat(t.Msg.Date,"</div>\n                    </div>"),(0,o.observeMessages)(r),(0,a.runLazyLoadMsg)(r),(0,a.runLazyLoadNotReadMsg)(r);break;case s.Connect:r.Uid=t.Uid,r.ChatId=t.ChatId;break;case s.ReadMsg:var d=document.querySelector('[data-msgid="'.concat(t.Msg.Id,'"]'));d.classList.contains("chat-content-msg-my-msg")&&d.querySelectorAll(".chat-msg-not-read-my").length>0&&d.querySelectorAll(".chat-msg-not-read-my")[0].remove(),d.classList.contains("chat-msg-not-read")&&d.classList.remove("chat-msg-not-read")}}})),t.addEventListener("close",(function(e){console.log("Close.")})),t.addEventListener("error",(function(e){console.error("Error:",e)})),document.getElementById("send").onclick=function(){var n={Type:s.TextMsg,Uid:r.Uid,ChatId:r.ChatId,Msg:{Text:e.value}};t.send(JSON.stringify(n)),e.value=""},r}},896:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.LazyLoad=void 0;var s=n(872),o=function(){function e(e,t,n){this.valuesData={},this.obsElementId=e,this.dataFields=t,this.url=n}return e.prototype.setOptions=function(e){this.options=e},e.prototype.getValues=function(e){for(var t=0,n=this.dataFields;t<n.length;t++){var s=n[t],o=e.getAttribute("data-"+s);null!=o&&(this.valuesData[s]=o)}return this.valuesData},e.prototype.setValue=function(e,t){this.valuesData[e]=t},e.prototype.run=function(e,t){for(var n=this,o=document.getElementsByClassName(this.obsElementId),a=new IntersectionObserver((function(o,a){o.forEach((function(o){o.isIntersecting&&(a.unobserve(o.target),(0,s.ajaxGET)(n.url,n.getValues(o.target),(function(t){e(t)}),(function(e){t(e)})),o.target.classList.remove(n.obsElementId),setTimeout((function(){for(var e=document.getElementsByClassName(n.obsElementId),t=0;t<e.length;t++)a.observe(e.item(t))}),1e3))}))}),this.options),r=0;r<o.length;r++)a.observe(o.item(r))},e}();t.LazyLoad=o},417:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.runLazyLoadNotReadMsg=t.runLazyLoadMsg=void 0;var s=n(896),o=n(842);function a(e,t){return"\n        <div ".concat(t.lastMsgData,' class="chat-content-msg ').concat(t.classes,'">\n            ').concat(t.isReadMy,'\n            <div class="chat-content-msg-text">\n                ').concat(e.Text,'\n            </div>\n            <div class="chat-content-msg-date">').concat(e.Date,"</div>\n        </div>")}t.runLazyLoadMsg=function(e){var t=new s.LazyLoad("last-msg",["first","msgtype","uid","chatid","msgid"],"/load-messages");t.setOptions({root:null,threshold:.5}),t.setValue("handler","read"),t.run((function(t){var n=document.getElementById("chat-content");if(t.error)console.log(t.error);else{var s=n.scrollTop,r=n.scrollHeight,c=t.type;if(1==t.first&&(c="read"),t.messages&&"read"==c){for(var i=t.messages,d=0;d<i.length;d++){var l={lastMsgData:'data-first="0" data-msgtype="'.concat(c,'" data-msgid="').concat(i[d].Id,'"'),isReadMy:"",classes:""};d==i.length-1&&(l.lastMsgData+='data-chatid="'.concat(t.chatId,'"'),l.classes+="last-msg"),t.uid==i[d].UserId&&(l.classes+=" chat-content-msg-my-msg"),t.uid!=i[d].UserId&&"0"==i[d].IsRead||("0"==i[d].IsRead&&(l.isReadMy='<div class="chat-msg-not-read-my"></div>'),document.getElementById("chat-content").insertAdjacentHTML("afterbegin",a(i[d],l)))}(0,o.observeMessages)(e)}else(0,o.observeMessages)(e);var u=n.scrollHeight;n.scrollTop=s+(u-r)}}),(function(e){console.log(e)}))},t.runLazyLoadNotReadMsg=function(e){var t=new s.LazyLoad("chat-msg-not-read-obs-down",["first","msgtype","uid","chatid","msgid"],"/load-messages");t.setOptions({root:null,threshold:.5}),t.setValue("handler","notread"),t.run((function(t){var n=document.getElementById("chat-content");if(t.error)console.log(t.error);else{var s=n.scrollTop,r=t.type;if(1==t.first&&(r="notread"),t.messages&&"notread"==r){for(var c=t.messages,i=0;i<c.length;i++){var d={lastMsgData:'data-first="0" data-msgtype="'.concat(r,'" data-msgid="').concat(c[i].Id,'"'),isReadMy:"",classes:""};i==c.length-1&&(d.lastMsgData+='data-chatid="'.concat(t.chatId,'"'),d.classes+="chat-msg-not-read-obs-down"),t.uid==c[i].UserId&&(d.classes+=" chat-content-msg-my-msg"),t.uid!=c[i].UserId&&"0"==c[i].IsRead&&(d.classes+=" chat-msg-not-read chat-msg-not-read-obs"),"0"==c[i].IsRead&&(d.isReadMy='<div class="chat-msg-not-read-my"></div>'),document.getElementById("chat-content").insertAdjacentHTML("beforeend",a(c[i],d))}(0,o.observeMessages)(e)}else(0,o.observeMessages)(e);n.scrollTop=s}}),(function(e){console.log(e)}))}},802:(e,t)=>{var n,s;Object.defineProperty(t,"__esModule",{value:!0}),t.RunWsNotification=t.NotificationType=void 0,function(e){e[e.WsConnect=0]="WsConnect",e[e.WsError=1]="WsError",e[e.WsIncrementChatMsgCount=2]="WsIncrementChatMsgCount",e[e.WsGlobalIncrementMsg=3]="WsGlobalIncrementMsg",e[e.WsGlobalDecrementMsg=4]="WsGlobalDecrementMsg"}(s||(t.NotificationType=s={}));var o=((n={})[s.WsConnect]=function(e,t){},n[s.WsError]=function(e,t){console.log(e.Msg.error)},n[s.WsIncrementChatMsgCount]=function(e,t){if("/chat-list"===window.location.pathname){var n=document.querySelector('[data-chatid="'.concat(e.Msg.chatId,'"]')).querySelector("#chat-list-user-msg-count"),s=parseInt(n.innerHTML);"number"==typeof s&&s++,n.innerHTML=String(s)}},n[s.WsGlobalIncrementMsg]=function(e,t){a(!0)},n[s.WsGlobalDecrementMsg]=function(e,t){a(!1)},n);function a(e){var t=document.getElementById("notification-count"),n=parseInt(t.innerText);e&&"number"==typeof n&&n++,e||"number"!=typeof n||n--,t.innerText=String(n)}t.RunWsNotification=function(){var e=new WebSocket("ws://localhost:8000/notification-ws");e.addEventListener("open",(function(e){console.log("Notification connect.")})),e.addEventListener("close",(function(e){})),e.onerror=function(e){console.log("Error: ",e)},e.onmessage=function(t){if(""!=t.data){var n=JSON.parse(t.data);o[n.Type](n,e)}}}},842:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.observeMessages=void 0;var s=n(653),o=n(862);t.observeMessages=function(e){new s.Observer("chat-msg-not-read-obs",{root:null,threshold:.7}).run((function(t){var n=t.target.getAttribute("data-msgid");if(null!=n){var s={Type:o.MsgType.ReadMsg,Uid:e.Uid,ChatId:e.ChatId,Msg:{Id:n}};setTimeout((function(){e.Socket.send(JSON.stringify(s))}),100)}}))}},653:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Observer=void 0;var n=[],s=function(){function e(e,t){this.className=e,this.options=t}return e.prototype.run=function(e){for(var t=this,s=document.getElementsByClassName(this.className),o=new IntersectionObserver((function(s,o){s.forEach((function(s){s.isIntersecting&&!n.includes(s.target)&&(e(s),s.target.classList.remove(t.className),o.unobserve(s.target),n.push(s.target))}))}),this.options),a=0;a<s.length;a++)o.observe(s.item(a))},e}();t.Observer=s},779:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.runIfExist=void 0,t.runIfExist=function(e,t){e&&t(e)}}},t={};function n(s){var o=t[s];if(void 0!==o)return o.exports;var a=t[s]={exports:{}};return e[s](a,a.exports,n),a.exports}n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{n(391);var e=n(779),t=n(872),s=n(862),o=n(417),a=n(802);(0,e.runIfExist)(document.getElementById("header-user"),(function(e){e.onclick=function(){document.getElementById("hu-menu").classList.toggle("hu-menu-hidden")}})),(0,e.runIfExist)(document.getElementById("pc-menu-filter-value"),(function(e){e.onclick=function(){document.getElementById("filter-items").classList.toggle("filter-items-hidden")}})),(0,e.runIfExist)(document.getElementById("pp-del-avatar-label"),(function(e){e.onclick=function(){document.getElementById("pp-del-avatar").classList.toggle("page-panel-checkbox-true")}}));var r=new t.Ajax("/subscribe-post","subscribe-post");if(r.onSuccess((function(e){var t=document.getElementById("profile-button-subscribe"),n=document.getElementById("subscribers-value"),s=parseInt(n.innerHTML);t.classList.toggle("profile-button-unsubscribe"),t.classList.contains("profile-button-unsubscribe")?(s++,t.innerHTML='<a><img src="/static/img/subscribe.svg">Unsubscribe</a>'):(s>0&&s--,t.innerHTML='<a><img src="/static/img/subscribe.svg">Subscribe</a>'),n.innerHTML=String(s)})),r.listen(),(0,a.RunWsNotification)(),/^\/chat\/\d+$/.test(window.location.pathname)){var c=(0,s.RunWs)();(0,o.runLazyLoadMsg)(c),(0,o.runLazyLoadNotReadMsg)(c)}})()})();